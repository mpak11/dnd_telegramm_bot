const BaseHandler = require('../../core/BaseHandler');
const { User, Character } = require('../../../database/models');
const config = require('../../../config/config');

class GeneralHandler extends BaseHandler {
  async handleStart(ctx) {
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await User.findOrCreate(ctx.from);

    let welcomeText = `
üé≤ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ D&D Bot!**

–Ø - –≤–∞—à –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≤ –º–∏—Ä–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π!

**üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
/create - –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
/hero - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
/stats - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/inventory - –û—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
/quest - –¢–µ–∫—É—â–∏–π –∫–≤–µ—Å—Ç
/quests - –ò—Å—Ç–æ—Ä–∏—è –∫–≤–µ—Å—Ç–æ–≤
/help - –°–ø—Ä–∞–≤–∫–∞

**üìñ –ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–æ–º–∞–Ω–¥–æ–π /create
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É –∏ –∫–ª–∞—Å—Å
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤ (1-3 –≤ –¥–µ–Ω—å)
4. –ë—Ä–æ—Å–∞–π—Ç–µ –∫—É–±–∏–∫ –∏ –∏—Å–ø—ã—Ç—ã–≤–∞–π—Ç–µ —Å—É–¥—å–±—É!
5. –ü–æ–ª—É—á–∞–π—Ç–µ –æ–ø—ã—Ç, –∑–æ–ª–æ—Ç–æ –∏ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã!
`;

    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –¥–ª—è –≥—Ä—É–ø–ø
    if (ctx.chat.type === "group" || ctx.chat.type === "supergroup") {
      welcomeText += `
**‚ö†Ô∏è –î–ª—è –≥—Ä—É–ø–ø —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /quickcreate –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
–ü—Ä–∏–º–µ—Ä: /quickcreate human WARRIOR –ì–æ—Ä–∞–∫
`;
    }

    welcomeText += `
–ö–≤–µ—Å—Ç—ã –≤—ã–¥–∞—é—Ç—Å—è —Å 10:00 –¥–æ 22:00 –ø–æ –ú–°–ö
`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂
    const character = await Character.findActive(ctx.from.id, ctx.chat.id);

    const buttons = character
      ? [[{ text: "üë§ –ú–æ–π –≥–µ—Ä–æ–π", callback_data: "show_hero" }]]
      : [[{ text: "üé≠ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", callback_data: "create_character" }]];

    await ctx.reply(welcomeText, {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: buttons,
      },
    });
  }

  async handleHelp(ctx) {
    const helpText = `
üìñ **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º**

**–ü–µ—Ä—Å–æ–Ω–∞–∂:**
/create - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
/quickcreate - –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ (–¥–ª—è –≥—Ä—É–ø–ø)
/hero - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ
/stats - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/inventory - –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
/improve - –£–ª—É—á—à–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ üíé
/improvements - –ò—Å—Ç–æ—Ä–∏—è —É–ª—É—á—à–µ–Ω–∏–π
/delete - –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
/setname - –í–≤–µ—Å—Ç–∏ –∏–º—è (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
/graveyard - –ö–ª–∞–¥–±–∏—â–µ –≥–µ—Ä–æ–µ–≤ ‚ö∞Ô∏è

**–ö–≤–µ—Å—Ç—ã:**
/quest - –¢–µ–∫—É—â–∏–π –∫–≤–µ—Å—Ç –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
/quests - –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤
/getquest - –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –∫–≤–µ—Å—Ç –≤—Ä—É—á–Ω—É—é

**–ü—Ä–µ–¥–º–µ—Ç—ã –∏ –æ–±–º–µ–Ω:**
/inventory - –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
/trade - –ù–∞—á–∞—Ç—å –æ–±–º–µ–Ω —Å –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–æ–º
/trades - –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞
/give - –ü–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
/chest - –°–æ–∑–¥–∞—Ç—å —Å—É–Ω–¥—É–∫ —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏
/use - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç

**–ü—Ä–æ—á–µ–µ:**
/status - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
/check_bot - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

**üéØ –°–∏—Å—Ç–µ–º–∞ –∫–≤–µ—Å—Ç–æ–≤:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ –≤ 10:00, 14:00, 18:00 –ú–°–ö
- –î–æ 3 –∫–≤–µ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å –Ω–∞ —á–∞—Ç
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 4 —á–∞—Å–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±—Ä–æ—Å–∫–∞ 1d20 + –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- **–£—Å–ø–µ—à–Ω—ã–µ –∫–≤–µ—Å—Ç—ã –¥–∞—é—Ç –ø—Ä–µ–¥–º–µ—Ç—ã!**

**üíé –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:**
- –†–µ–¥–∫–æ—Å—Ç—å: ‚ö™ –û–±—ã—á–Ω—ã–π ‚Üí üü¢ –ù–µ–æ–±—ã—á–Ω—ã–π ‚Üí üîµ –†–µ–¥–∫–∏–π ‚Üí üü£ –≠–ø–∏—á–µ—Å–∫–∏–π ‚Üí üü† –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π
- –ü—Ä–µ–¥–º–µ—Ç—ã –≤—ã–ø–∞–¥–∞—é—Ç –∏–∑ –∫–≤–µ—Å—Ç–æ–≤
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Å–ø–µ—Ö (20) –¥–∞–µ—Ç –±–æ–ª—å—à–µ –ª—É—Ç–∞
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ

**ü§ù –°–∏—Å—Ç–µ–º–∞ –æ–±–º–µ–Ω–∞:**
- –û–±–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö
- –ú–æ–∂–Ω–æ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –∑–æ–ª–æ—Ç–æ
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤—É—é—Ç 5 –º–∏–Ω—É—Ç
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º

**üíé –£–ª—É—á—à–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫:**
- –ù–∞ 4 –∏ 8 —É—Ä–æ–≤–Ω—è—Ö –¥–∞—é—Ç—Å—è 2 –æ—á–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å 2 –æ—á–∫–∞ –Ω–∞ +2 –∫ –æ–¥–Ω–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–µ
- –ò–ª–∏ –ø–æ 1 –æ—á–∫—É –Ω–∞ +1 –∫ –¥–≤—É–º —Ä–∞–∑–Ω—ã–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: 20

**üíÄ –°–º–µ—Ä—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:**
- –ü—Ä–∏ HP = 0 –ø–µ—Ä—Å–æ–Ω–∞–∂ —É–º–∏—Ä–∞–µ—Ç
- –ú–µ—Ä—Ç–≤—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –Ω–µ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–≤–µ—Å—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /create –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≥–µ—Ä–æ—è
- /graveyard - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–∞–≤—à–∏—Ö –≥–µ—Ä–æ–µ–≤

**üìù –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø:**
/quickcreate —Ä–∞—Å–∞ –∫–ª–∞—Å—Å –∏–º—è

**–ü—Ä–∏–º–µ—Ä:**
/quickcreate human WARRIOR –ì–æ—Ä–∞–∫ –°–∏–ª—å–Ω—ã–π

**–†–∞—Å—ã:** human, elf, dwarf, halfling
**–ö–ª–∞—Å—Å—ã:** WARRIOR, ROGUE, MAGE, CLERIC, BARBARIAN, RANGER

–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: 10
–ö–≤–µ—Å—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Å 10:00 –¥–æ 22:00 –ú–°–ö

‚ö†Ô∏è **–î–ª—è —Ä–∞–±–æ—Ç—ã –≤ –≥—Ä—É–ø–ø–∞—Ö –±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏–ª–∏ –∏–º–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏**
`;

    await ctx.reply(helpText, { parse_mode: "Markdown" });
  }

  async handleStatus(ctx) {
    const chatId = ctx.chat.id;
    const userId = ctx.from.id;

    // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    const character = await Character.findActive(userId, chatId);

    const statusText = `
üìä **–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞**

üé≤ –í–µ—Ä—Å–∏—è: 2.0
üì± –ß–∞—Ç ID: ${chatId}
üë§ –í–∞—à ID: ${userId}
‚è∞ –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: ${new Date().toLocaleString("ru-RU", {
      timeZone: "Europe/Moscow",
    })} –ú–°–ö

${
      character
        ? `\nüé≠ –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂: ${character.name} (${character.level} —É—Ä.)`
        : "\n‚ùå –ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ —Å–æ–∑–¥–∞–Ω"
    }

–ö–≤–µ—Å—Ç—ã –≤—ã–¥–∞—é—Ç—Å—è —Å 10:00 –¥–æ 22:00 –ú–°–ö
`;

    await ctx.reply(statusText, { parse_mode: "Markdown" });
  }

  async handleCheckBot(ctx) {
    const chatId = ctx.chat.id;
    const chatType = ctx.chat.type;
    const botId = ctx.botInfo.id;

    let info = `ü§ñ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ**\n\n`;
    info += `‚Ä¢ –¢–∏–ø —á–∞—Ç–∞: ${chatType}\n`;
    info += `‚Ä¢ ID —á–∞—Ç–∞: \`${chatId}\`\n`;
    info += `‚Ä¢ ID –±–æ—Ç–∞: ${botId}\n`;

    if (chatType === "group" || chatType === "supergroup") {
      try {
        const chatMember = await ctx.getChatMember(botId);
        info += `‚Ä¢ –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: ${chatMember.status}\n`;

        if (chatMember.status === "administrator") {
          info += `‚Ä¢ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞: ‚úÖ\n`;
          info += `‚Ä¢ –ú–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: ${
            chatMember.can_read_all_group_messages ? "‚úÖ" : "‚ùå"
          }\n`;
        } else {
          info += `‚Ä¢ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞: ‚ùå\n`;
        }
      } catch (error) {
        info += `‚Ä¢ –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤: ${error.message}\n`;
      }

      info += `\n‚ö†Ô∏è **–í–ê–ñ–ù–û –¥–ª—è –≥—Ä—É–ø–ø:**\n`;
      info += `–î–ª—è —Ä–∞–±–æ—Ç—ã –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –≥—Ä—É–ø–ø–µ, –±–æ—Ç –¥–æ–ª–∂–µ–Ω:\n`;
      info += `1. –ë—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã\n`;
      info += `2. –ò–º–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–π "–†–µ–∂–∏–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏" –≤ @BotFather\n\n`;
      info += `**–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**\n`;
      info += `1. –°–¥–µ–ª–∞–π—Ç–µ –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã\n`;
      info += `2. –ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ @BotFather:\n`;
      info += `   ‚Ä¢ /mybots ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞\n`;
      info += `   ‚Ä¢ Bot Settings ‚Üí Group Privacy\n`;
      info += `   ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ "Turn off"\n`;
      info += `3. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–¥–∞–ª–∏—Ç–µ –∏ –∑–∞–Ω–æ–≤–æ –¥–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É\n`;
    } else {
      info += `\n‚úÖ –í –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ –≤—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!`;
    }

    await ctx.reply(info, { parse_mode: "Markdown" });
  }
}

module.exports = new GeneralHandler();